<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
      integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    {% load static %}
    <title>Document</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Ysabeau:wght@300&display=swap");
      h3,
      p {
        font-family: "Ysabeau", sans-serif;
      }
      .hidden {
        display: none;
      }
      .main_box {
        font-family: "Ysabeau", sans-serif;
        height: 100vh;
        width: 100%;
        display: flex;
      }
      .main_box .map_lay {
        width: 70%;
      }
      .main_box .channel_lay {
        width: 30%;
      }

      .main_box .map_lay .group {
        height: 25%;
      }

      #map {
        height: 75%;
      }

      .main_box .channel_lay .request_list {
        height: 50%;
        overflow: scroll;
      }

      .main_box .channel_lay .user_list {
        height: 50%;
        overflow: scroll;
      }

      .userlist .user {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px;
        border-bottom: 1px solid gray;
        border-top: 1px solid gray;
      }

      .userlist img {
        border-radius: 50%;
        object-fit: cover;
      }

      .list-item-content {
        width: 100%;
        margin-left: 20px;
      }

      .head {
        padding: 20px;
        background: black;
        color: white;
      }

      .selectbtn button,
      .getStartBtn button,
      .userlist button {
        padding: 12px 15px;
        color: white;
        background: black;
        border: none;
        border-radius: 20px;
        border: 1px solid;
        font-family: "Ysabeau", sans-serif;
        font-weight: 900;
      }

      .selectbtn button:hover,
      .getStartBtn button:hover,
      .userlist button:hover {
        color: black;
        background: white;
      }

      .stories-container {
        display: flex;
        flex: 74px;
        gap: 1rem;
        padding: 1rem;
        background: white;
        border-radius: 3px;
        overflow-x: scroll;
        user-select: none;
      }
      figure {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        margin: 0;
        transition: transform 0.2s ease-in-out;
        cursor: pointer;
      }
      figure > figcaption {
        max-width: 74px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-family: system-ui, sans-serif;
        font-size: 12px;
        font-weight: 400;
        line-height: 16px;
        text-align: center;
        color: #262626;
      }
      figure:hover {
        transform: scale(1.1);
      }
      picture {
        display: flex;
        justify-content: center;
        align-items: center;
        background: radial-gradient(white 66%, transparent 0),
          linear-gradient(
            45deg,
            #f09433 0%,
            #e6683c 25%,
            #dc2743 50%,
            #cc2366 75%,
            #bc1888 100%
          );
        padding: 5px;
        border-radius: 50%;
      }
      .personal {
        background: none;
      }
      picture > img {
        width: 64px;
        aspect-ratio: 1;
        object-fit: cover;
        border: 1px solid #b1b1b1;
        border-radius: 50%;
      }

      #group_per i {
        position: absolute;;
        margin-left: 50px;
        margin-top: -50px;
        font-size: 20px;
      }

      .groupdetail {
        display: flex;
        align-items: center;
      }

      .popupnotify {
        width: 550px;
        height: 400px;
        background: black;
        position: fixed;
        z-index: 99999;
        top: 35%;
        left: 25%;
      }

      .popupnotify .closenotify {
        float: right;
        padding: 12px 20px;
        font-size: 30px;
      }

      .popupnotify .logonotify {
        display: grid;
        justify-items: center;
        padding: 50px 20px;
      }

      .popupnotify .notify {
        color: white;
        font-size: xx-large;
        padding: 20px 50px;
      }

      .popupnotify .selectbtn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        padding: 30px;
      }


      .container {
        position: absolute;
        display: block;
        width: 80px;
        margin: 60px auto;
        bottom: 30vh;
        left: 25vw;
        }
      
       .container .delay1 {
          animation: waves 2.5s linear infinite;
          animation-delay: .1s;
        }
        
        .container .delay2 {
          animation: waves 2.5s linear .7s forwards infinite,
        }
        
        .container .delay3 {
          animation: waves 2.5s linear 1.3s forwards infinite;
        }
        
        .container .delay4 {
          animation: waves 2.5s linear 1.9s forwards infinite;
        }

      .circle {
        display: block;
        height: 150px;
        width: 150px;
        border-radius: 50%;
        background: #0fbcf845;
        margin: 10px;
        transition: 5s ease;
        position: absolute;
        top: 0px
      }
      
      @-webkit-keyframes waves {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        
        100% {
          transform: scale(4);
          opacity: 0;
        }
      }

    </style>
  </head>
  <body>
    {% include 'layout/navbar.html' %}

    <div class="main_box">
      <div class="map_lay">
        <div class="group">
          <div class="head"><h3>Group :</h3></div>
          <div class="groupdetail">
            <div class="stories-container" id="group_per"></div>
            <div class="getStartBtn"><button onclick="startNow()">Start Now</button></div>
          </div>
        </div>
        <div id="map">
        </div>
        <div class="container">
          <div class="circle delay1"></div>
          <div class="circle delay2"></div>
          <div class="circle delay3"></div>
          <div class="circle delay4"></div>
        </div>
      </div>
      <div class="channel_lay">
        <div class="request_list">
          <div class="head"><h3>Request List :</h3></div>
          <div class="userlist" id="requestlist"></div>
        </div>
        <div class="user_list">
          <div class="head"><h3>User List :</h3></div>
          <div class="userlist" id="userlist"></div>
        </div>
      </div>
    </div>

    <div class="popupnotify hidden" id="popupnotify">
      <div class="closenotify">
        <i
          class="fas fa-times"
          style="color: white"
          onclick="clearSathiId()"
        ></i>
      </div>
      <div class="logonotify">
        <img src="{% static 'images/sathichal.png' %}" width="200px" alt="" />
      </div>
      <div class="notify">With which group you want to continue ?</div>
      <div class="selectbtn">
        <button onclick="closeNotify()">Current Group</button>
        <button onclick="clearSathiId()">Create New Group</button>
      </div>
    </div>
    <div id="test"></div>

    <!-- prettier--ignore -->
    {% include 'layout/footer.html' %}

    <script>
      if (localStorage.getItem("sathiId")) {
        document.getElementById("popupnotify").classList.remove("hidden");
      }

      let source = JSON.parse(localStorage.getItem("source"));
      let destination = JSON.parse(localStorage.getItem("destination"));
      var location_data = {
        source: source,
        destination: destination,
      };
      console.log(location_data);
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAsZwc4NHo2JhjvtoFmv5N89u7Ta042KtE&libraries=places"></script>
    <script>
      const map = new google.maps.Map(document.getElementById('map'), {
          center: { lat: {{source.lat}}, lng: {{source.lng}} },
          zoom: 18,
          scrollwheel: false,
        });
    </script>

    <script>
      const routeSocket = new WebSocket(
        "ws://" +
          window.location.host +
          "/ws/routing/" +
          "{{source.lat}}/" +
          "{{source.lng}}/" +
          "{{destination.lat}}/" +
          "{{destination.lng}}/"
      );

      var sathiId = "";

      routeSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        console.log(data);

        if (data.type == "connection") {
          routeSocket.send(
            JSON.stringify({
              type: "user_location",
              username: "{{user}}",
              location_data,
            })
          );
        }

        if (data.type == "disconnected") {
          removeUserlist(data.username);
          removeRequest(data.username);
        }
        // infowindow variable
        var infoWindow = new google.maps.InfoWindow();

        if (data.type == "auto" && (data.event = "user_location")) {
          var marker = new google.maps.Marker({
            position: data.data.location.source,
            map: map,
            draggable: true,
          });
          map.setCenter(data.data.location.source);
          addUserlist(data.data.user_data);

          // set infowindow content when page loads
          infoWindow.setContent(
            "<h3>" + data.data.user_data.username + "</h3>"
          );
          infoWindow.open(map, marker);

          if (data.data.user_data.username == "{{user}}") {
            addGroupMember(
              data.data.user_data.username,
              data.data.user_data.profile_pic
            );
          }
        }

        if (data.type == "success") {
          var marker = new google.maps.Marker({
            position: data.data.location.source,
            map: map,
            draggable: true,
          });
          map.setCenter(data.data.location.source);
          // set infowindow content when page loads
          infoWindow.setContent(
            "<h3>" + data.data.user_data.username + "</h3>"
          );
          infoWindow.open(map, marker);

          const temp_map = infoWindow.getMap();
          // marker.addEventListener("mouseover", () => {
          //   infoWindow.open(temp_map, marker);
          // });
          addExistlist(data.data.user_data);
        }

        if (data.type == "sendRequest") {
          addRequest(data.data);
        }

        if (data.type == "confirmed") {
          if((data.data.added_user.username == "{{user}}")||(data.data.added_by_user.username == "{{user}}")){
            sathiId = data.Sathi_Id;
            localStorage.setItem("sathiId", sathiId);
            getGroupdata();
          }
          getGroupdata();
        }

        if(data.type == "startnow"){
          console.log(data);
          if((localStorage.getItem('sathiId'))&&(localStorage.getItem('sathiId') == data.Sathi_Id)){
            window.location.href = "/route/startroute/"+data.Sathi_Id;
          }
        }

      };

      routeSocket.onclose = function (e) {
        console.error("Chat socket closed unexpectedly");
      };

      //   send request to the user

      function sendRequest(username) {
        routeSocket.send(
          JSON.stringify({
            type: "sendRequest",
            reciver: username,
            sender: "{{user}}",
          })
        );
        removeUserlist(username);
      }

      //   send confirm to the user function

      function sendConfirm(username) {
        routeSocket.send(
          JSON.stringify({
            type: "sendConfirm",
            reciver: username,
            sender: "{{user}}",
            sathiID: sathiId,
          })
        );
        removeRequest(username);
      }

      function startNow(){
        routeSocket.send(
          JSON.stringify({
            type: "startnow",
            sathiID: sathiId,
          })
        );
      }

    </script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script>
      function addUserlist(user_data) {
        var myEle = document.getElementById(user_data.username);
        // if user present in group member list the do not add in user list
        var groupMember = document.getElementById("mem_" + user_data.username);
        if (user_data.username != "{{user}}" && !myEle && !groupMember) {
          if (user_data.profile_pic == null) {
            var user_img = "{% static 'images/profile.jpg' %}";
          } else {
            var user_img = user_data.profile_pic;
          }
          let mem =
            `
                    <div class='user' id='` +
            user_data.username +
            `'>
                        <img src="` +
            user_img +
            `" class="list-item-image" width="50px" height="50px">
                        <div class="list-item-content">
                            <h3>` +
            user_data.first_name +
            `  ` +
            user_data.last_name +
            `</h3>
                            <p>@` +
            user_data.username +
            `</p>
                        </div>
                        <button id="user_` +
            user_data.username +
            `" onclick="sendRequest('` +
            user_data.username +
            `')"> Send Request </button>
                    </div>
                    `;
          $("#userlist").append(mem);
          routeSocket.send(
            JSON.stringify({
              type: "success",
              username: "{{user}}",
              location_data,
            })
          );
        }
      }

      function addExistlist(user_data) {
        var myEle = document.getElementById(user_data.username);
        const group_member = document.getElementById(user_data.username);
        if (user_data.username != "{{user}}" && !myEle && !group_member) {
          if (user_data.profile_pic == null) {
            var user_img = "{% static 'images/profile.jpg' %}";
          } else {
            var user_img = user_data.profile_pic;
          }
          let mem =
            `
                    <div class='user' id='` +
            user_data.username +
            `'>
                        <img src="` +
            user_img +
            `" class="list-item-image" width="50px" height="50px">
                        <div class="list-item-content">
                            <h3>` +
            user_data.first_name +
            `  ` +
            user_data.last_name +
            `</h3>
                            <p>@` +
            user_data.username +
            `</p>
                        </div>
                        <button id="user_` +
            user_data.username +
            `" onclick="sendRequest('` +
            user_data.username +
            `')"> Send Request </button>
                    </div>
                    `;
          $("#userlist").append(mem);
        }
      }

      function removeUserlist(user_data) {
        $("#" + user_data).remove();
      }

      function addRequest(user_data) {
        if (user_data.reciver == "{{user}}") {
          if (user_data.user_data.profile_pic == null) {
            var user_img = "{% static 'images/profile.jpg' %}";
          } else {
            var user_img = user_data.user_data.profile_pic;
          }
          let mem =
            `
                    <div class='user' id='req_` +
            user_data.user_data.username +
            `'>
                        <img src="` +
            user_img +
            `" class="list-item-image" width="50px" height="50px">
                        <div class="list-item-content">
                            <h3>` +
            user_data.user_data.first_name +
            `  ` +
            user_data.user_data.last_name +
            `</h3>
                            <p>@` +
            user_data.user_data.username +
            `</p>
                        </div>
                        <button id="user_` +
            user_data.user_data.username +
            `" onclick="sendConfirm('` +
            user_data.user_data.username +
            `')"> Confirm </button>
                    </div>
                    `;
          $("#requestlist").append(mem);
          removeUserlist(user_data.user_data.username);
        }
      }

      function removeRequest(user_data) {
        $("#req_" + user_data).remove();
      }

      function addGroupMember(username, profile_pic) {
        //  remove user from userlist
        const userList = document.getElementById(username);
        if (userList) {
          userList.remove();
        }
        // if user is not in group then add user to group
        const is_member = document.getElementById("mem_" + username);
        if (!is_member) {
          if (!profile_pic) {
            profile_pic = "{% static 'images/profile.jpg' %}";
          }
          if (username == "{{user}}") {
            var pers =
              `
                <figure id="mem_` +
              username +
              `">
                    <picture class="personal">
                        <img src="` +
              profile_pic +
              `"/>
                    </picture>
                    <figcaption>{{user}}</figcaption>
                </figure>
                `;
            $("#group_per").append(pers);
          } else {
            var pers =
              `
          <figure id="mem_` +
              username +
              `">
          <picture>
            <i class="fas fa-times-circle"></i>
            <img src="` +
              profile_pic +
              `"/>
            </picture>
            <figcaption>` +
              username +
              `</figcaption>
              </figure>
              `;
            $("#group_per").append(pers);
          }
        }
      }

      function clearSathiId() {
        var temp = localStorage.getItem("sathiId");
        console.log(temp);
        $.ajax({
          url: "{% url 'groupupdate' %}",
          type: "POST",
          data: {
            sathiId: temp,
            username: "{{user}}",
            csrfmiddlewaretoken: "{{ csrf_token }}",
          },
          dataType: "json",
          success: function (result) {
            console.log(result);
            if (result.status) {
              console.log("success result");
              sathiId = "";
              localStorage.removeItem("sathiId");
              document.getElementById("popupnotify").classList.add("hidden");
            }
            console.log(result);
          },
        });
      }

      function closeNotify() {
        document.getElementById("popupnotify").classList.add("hidden");
        getGroupdata();
      }

      function getGroupdata(){
        sathiId = localStorage.getItem("sathiId");
        $.ajax({
          url: "{% url 'groupget' %}",
          type: "POST",
          data: {
            sathiId: sathiId,
            csrfmiddlewaretoken: "{{ csrf_token }}",
          },
          dataType: "json",
          success: function (result) {
            let content = "";
            if (result) {
              var cars = result.response;
              cars.forEach((item) => {
                const value = Object.values(item);
                console.log(value);
                const memberDiv = document.getElementById("mem_" + value[0]);
                if (!memberDiv) {
                  addGroupMember(value[0], value[2]);
                }
              });
            }
            console.log(result.response);
          },
        });
      }

    </script>
  </body>
</html>
